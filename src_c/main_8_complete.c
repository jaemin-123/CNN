
#include <stdio.h>
#include <stdint.h>

// ==========================================
// 1. DATA SECTION (Hardcoded Params)
// ==========================================
const int test_label = 7;
const int32_t MULT_L1 = 119;
const int32_t MULT_L2 = 116;
const int32_t MULT_FC = 196;

// Input Image (28x28)
const int8_t input_img[784] = { -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 29, 87, 72, 67, 15, 2, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 108, 126, 126, 126, 126, 119, 94, 94, 94, 94, 94, 94, 94, 94, 78, 11, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 19, 46, 22, 46, 74, 111, 126, 110, 126, 126, 126, 124, 112, 126, 126, 61, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -9, 19, -11, 19, 19, 19, 15, -7, 116, 126, 42, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 28, 126, 101, -9, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -6, 114, 127, 28, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 55, 126, 117, 6, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 15, 124, 126, 16, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 57, 126, 88, -16, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -14, 98, 123, 14, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 53, 126, 85, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 24, 125, 118, 14, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -8, 108, 126, 76, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -17, 97, 126, 106, 1, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 3, 126, 126, 25, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -1, 109, 126, 47, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 57, 126, 126, 11, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 16, 120, 126, 126, 11, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 50, 126, 126, 106, 4, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, 50, 126, 99, -9, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19, -19 };

// Weights (Bias Removed)
const int8_t w_l1[75] = { -45, -64, -62, -36, -53, -63, -85, -56, -46, -76, 73, 24, 36, 60, 54, 61, 86, 55, 25, 33, 35, 13, 18, 6, 1, 3, 17, -8, 5, 83, -1, 19, 7, 37, 102, -15, 36, 59, 30, 52, 45, 51, 75, 18, 18, 33, 60, 39, -19, -27, -8, -27, -89, -98, -109, -16, -111, -73, -36, -33, -96, -97, -21, 6, 63, -127, -37, 43, 51, 33, -109, -52, 4, 31, 16 };
const int8_t w_l2[225] = { 5, 22, 64, 31, 26, 35, 8, 82, 107, 28, 96, 83, 70, 58, 77, 81, 33, -9, 15, 20, 25, 21, 14, -22, -25, -15, -2, 69, 76, 30, -85, -78, -53, -79, -63, -59, -81, -78, -82, -38, 31, -53, -32, -4, 32, 7, 3, 8, -10, 6, -30, -19, -24, 7, -33, 27, 28, 47, 89, -4, 16, 50, 83, 63, 92, -42, 73, 97, 62, 127, -45, 24, 27, 22, 70, 45, 16, 30, 25, -29, 87, 39, 76, 68, 5, 60, 46, 72, 59, 19, 31, 34, 10, 50, 86, 60, 10, -26, 11, 62, -3, 10, -31, 13, 30, 16, -20, -63, -29, -30, 2, 1, -8, 6, 10, 2, -2, -11, 26, 84, -8, -50, -48, -29, 34, 46, 36, 40, 55, 34, -40, -60, -64, 16, -32, -13, -70, -111, -118, -59, 37, -29, -125, -58, -48, 87, 59, -8, 9, 50, -30, 14, -45, 33, 6, -11, -25, -71, 6, -11, -76, -41, -7, 52, 42, -50, 55, 72, 50, 2, -24, 51, 51, 56, 20, 14, 20, -55, -36, -30, 55, -11, -26, -53, 23, 57, 4, 28, 50, 64, 29, 27, 49, 76, 2, 13, -14, -18, -23, -26, 23, 49, 46, -6, -38, 65, 80, 6, -29, -71, 73, 55, 9, -16, -10, -40, -44, -35, -2, 3, -50, -36, -61, -59, 15 };
const int8_t w_l3[480] = { 20, -10, -23, 23, 22, -31, 42, -52, -119, -2, 21, -62, -83, -13, 71, 27, -24, -33, 22, 45, -11, -11, -18, 25, 0, -5, 12, -47, -26, -12, 15, 23, 22, 0, -10, 9, 11, -53, -64, -7, -10, 51, 31, -14, -19, 36, 42, -28, -25, -5, 8, 22, 63, 7, -101, -5, 35, -36, -25, 61, 41, -15, 9, 27, 65, -39, -89, -85, -72, -9, -30, -127, -5, 17, -29, -61, 21, -13, -42, 22, -5, 54, -24, 70, 20, -65, -38, 44, 2, -18, -41, 107, 99, -116, 0, 77, 2, -56, -21, -6, 50, 30, 6, -80, 48, 8, -9, -35, -76, -16, 0, 59, -3, -3, 1, 9, 1, 27, 24, 1, 2, 18, 32, 6, -31, -52, 6, 77, 4, -22, -59, -49, 45, -59, -27, -38, 58, 7, 32, 19, 11, 1, -3, 38, 5, -11, -30, -67, 68, 40, -71, -43, -5, -27, -8, 58, 26, 65, -13, -83, 66, 26, -4, -6, -44, -12, 13, 13, 3, 27, 11, 27, 36, 30, 26, 1, -11, 29, -31, 7, -11, -8, 3, 5, -26, -31, -45, -11, 5, -28, 2, -45, 24, -1, 58, 19, -45, -57, -62, -65, -67, 19, 23, -17, 53, 7, -51, 6, -1, -57, -50, -107, -2, 46, 0, -52, -8, 18, 14, -13, -49, 51, 39, -8, -31, -23, 0, -8, 50, 55, 57, 57, -55, 42, -16, 25, -18, -40, -87, 19, -27, 0, -10, -18, -54, -72, 64, 103, -29, -54, -12, 41, 35, 29, 0, -86, 6, -33, -30, 71, -9, -34, 24, 44, 27, 26, -30, 54, 62, 23, 31, -12, -18, 25, 10, 36, 16, -25, -41, -64, -6, -18, -40, -73, 7, 3, 18, -10, -1, 27, 8, -17, -43, -23, 37, 116, -105, -26, 13, 4, -101, -55, -30, -9, -70, -79, -88, -4, -16, -39, 0, 95, 26, -13, 3, 6, 6, -13, 30, 32, -22, 5, -16, 25, -8, -11, 45, 4, -15, 14, 24, -3, -46, 38, 64, -12, -28, 26, 0, -8, 1, 52, -5, -56, 36, 8, 49, -68, 56, -34, -64, 6, 44, 56, 36, -6, -38, -22, -32, 14, -49, 4, 2, 22, -89, 15, -52, -14, 24, 30, 20, 37, 35, -39, -73, 4, 22, 6, 18, -8, -70, -69, -70, -72, -14, -28, -19, -10, -58, 2, 4, 9, 24, -73, -25, 44, -55, -71, 38, 33, -23, 13, -1, 42, 42, 52, -14, -1, -25, 8, 35, -14, 13, -4, -10, 0, -1, -14, 16, 2, -30, -7, 36, 1, 27, -37, -4, -59, -25, 16, 42, 21, 43, 8, -39, 16, -46, -10, -6, 18, -84, 34, 32, -114, 60, 24, -19, -18, -18, 42, -4, 42, 21, -6, -30, 2, 18, 1, 6, -62, -36, 35, 77, -33, 14, 29, 23, -60, -42, 55, 28, 7, -32, 1, -52, -62, -13, -30, -110, -22 };


// ==========================================
// 2. MATH SECTION (Fixed Point Logic)
// ==========================================
int8_t apply_hw_requantize(int32_t acc, int32_t multiplier) {
    int64_t scaled = (int64_t)acc * multiplier;
    int32_t shifted = (int32_t)(scaled >> 16); 
    if (shifted > 127)  return 127;
    if (shifted < -128) return -128;
    return (int8_t)shifted;
}

void conv2d_fixed(const int8_t* input, int in_w, const int8_t* kernel, int32_t multiplier, int8_t* output, int out_w) {
    int y, x, ky, kx;
    int32_t acc;
    for (y = 0; y < out_w; y++) {
        for (x = 0; x < out_w; x++) {
            acc = 0;
            for (ky = 0; ky < 5; ky++) {
                for (kx = 0; kx < 5; kx++) {
                    acc += (int32_t)input[(y + ky) * in_w + (x + kx)] * (int32_t)kernel[ky * 5 + kx];
                }
            }
            // No Bias -> Requantize -> ReLU
            int8_t val = apply_hw_requantize(acc, multiplier);
            output[y * out_w + x] = (val < 0) ? 0 : val;
        }
    }
}

void conv2d_3ch_fixed(const int8_t* input, const int8_t* kernel, int32_t multiplier, int8_t* output, int dim) {
    int H_out = dim - 4; 
    int y, x, c, ky, kx;
    int32_t acc;
    for (y = 0; y < H_out; y++) {
        for (x = 0; x < H_out; x++) {
            acc = 0;
            for (c = 0; c < 3; c++) {
                const int8_t* ch_img = input + (c * dim * dim);
                const int8_t* ch_ker = kernel + (c * 25);
                for (ky = 0; ky < 5; ky++) {
                    for (kx = 0; kx < 5; kx++) {
                        acc += (int32_t)ch_img[(y + ky) * dim + (x + kx)] * (int32_t)ch_ker[ky * 5 + kx];
                    }
                }
            }
            int8_t val = apply_hw_requantize(acc, multiplier);
            output[y * H_out + x] = (val < 0) ? 0 : val;
        }
    }
}

void pooling2d_fixed(const int8_t *x, int8_t *y, int C_out, int H, int W, int stride) {
    int c, i, j, kh, kw;
    int H_new = H / stride;
    int W_new = W / stride;
    for (c = 0; c < C_out; c++) {
        for (i = 0; i < H_new; i++) {
            for (j = 0; j < W_new; j++) {
                int8_t max_val = -128;
                for (kh = 0; kh < 2; kh++) {
                    for (kw = 0; kw < 2; kw++) {
                        int8_t val = x[c*H*W + (i*stride+kh)*W + (j*stride+kw)];
                        if (val > max_val) max_val = val;
                    }
                }
                y[c*H_new*W_new + i*W_new + j] = max_val;
            }
        }
    }
}

void mat_mult_fixed(const int8_t *mat_l, const int8_t *mat_r, int8_t *result, int K, int M, int32_t multiplier) {
    int m, k;
    int32_t acc;
    for (m = 0; m < M; m++) { 
        acc = 0;
        for (k = 0; k < K; k++) { 
            acc += (int32_t)mat_l[k] * (int32_t)mat_r[m*K + k]; 
        }
        result[m] = apply_hw_requantize(acc, multiplier);
    }
}

// ==========================================
// 3. MAIN (Execution)
// ==========================================
// main 함수 전체를 이걸로 덮어쓰세요
int main() {
    int i, ch;
    
    // Buffers
    int8_t l1_out[3 * 144];
    int8_t conv1_temp[576];
    int8_t l2_out[3 * 16];
    int8_t conv2_temp[64];
    int8_t fc_out[10];

    // 1. 입력 로드 (수정됨: 1차원 배열 접근)
    // main_8_complete.c에서는 test_image가 1차원 배열입니다.
    int8_t input_buffer[784];
    for(i=0; i<784; i++) {
        input_buffer[i] = (int8_t)test_image[i]; 
    }

    printf("=== DEBUG START: Image 0 ===\n");
    printf("True Label: %d\n", test_label);

    // -----------------------------------------------------
    // Layer 1 실행
    // -----------------------------------------------------
    for(ch = 0; ch < 3; ch++) {
        conv2d_fixed(input_buffer, 28, &w_l1[ch * 25], MULT_L1, conv1_temp, 24);
        pooling2d_fixed(conv1_temp, &l1_out[ch * 144], 1, 24, 24, 2);
    }

    // ★★★ [DEBUG] Layer 1 Channel 0의 앞부분 10개 출력 ★★★
    printf("C Code Layer 1 (CH0) Output:\n");
    for(i=0; i<10; i++) {
        // Channel 0의 시작 위치부터 10개
        printf("%d ", l1_out[i]); 
    }
    printf("\n\n");
    
    // 이 뒤로는 에러가 나든 말든 일단 Layer 1 값만 보면 되므로 종료해도 됨
    return 0;
}
